<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Why we wrote Herodotus | DVLA Engineering</title><meta name=keywords content="ruby,logging"><meta name=description content="A look at the gem Herodotus and the problems we have been using it to solve."><meta name=author content="George Bell"><link rel=canonical href=https://dvla.github.io/posts/2023-05-logging-with-herodotus/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://dvla.github.io/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dvla.github.io/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dvla.github.io/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://dvla.github.io/favicon/apple-touch-icon.png><link rel=mask-icon href=https://dvla.github.io/favicon/favicon-16x16.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-WH4N9FEEE8"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-WH4N9FEEE8",{anonymize_ip:!1})}</script><meta property="og:title" content="Why we wrote Herodotus"><meta property="og:description" content="A look at the gem Herodotus and the problems we have been using it to solve."><meta property="og:type" content="article"><meta property="og:url" content="https://dvla.github.io/posts/2023-05-logging-with-herodotus/"><meta property="og:image" content="https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-17T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-17T00:00:00+00:00"><meta property="og:site_name" content="DVLA Engineering"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Why we wrote Herodotus"><meta name=twitter:description content="A look at the gem Herodotus and the problems we have been using it to solve."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dvla.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Why we wrote Herodotus","item":"https://dvla.github.io/posts/2023-05-logging-with-herodotus/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Why we wrote Herodotus","name":"Why we wrote Herodotus","description":"A look at the gem Herodotus and the problems we have been using it to solve.","keywords":["ruby","logging"],"articleBody":"We’ve written Herodotus1 as a lightweight logger to solve some very specific problems we had in our tests, but we don’t think they are unique to us so we’re going to share with you what we have done and why.\nLogging to the standard output and the main problem we faced The problem we are trying to solve is one of readability. All good logs are human readable, as when something has gone wrong to the point of a human needing to look in the logs and piece together what has happened we don’t want to make that more difficult than is needed. Now, there are things out there that will help you manage your logs (for example, OpenSearch provides a fantastic toolkit for exploring a large volume of logs), these are often looking at things on a grander scale than we are. There are always going to be times where you want your system to just leave a little message wherever it is currently running, which is why we are looking at things that are logging to the standard output on whatever device they are running. Specifically in our case, we are looking at the output of an automated test pack.\nTake the following code snippet, where we set up a default ruby logger and seed a database (that has access to the same global logger) for three different test scenarios, along with the output when we run it:\nmodule DatabaseAccess def self.seed_database(test_data) Database.add_record(test_data[:name], test_data[:dob]) end end LOGGER = Logger.new(STDOUT) test_data = [ { name: 'Alice', dob: '14/07/1982' }, { name: 'Bob', dob: '23/01/1992' }, { name: 'Carol', dob: '09/12/1975' } ] Parallel.map(test_data, in_processes: 2) do |person| LOGGER.info(\"Seeding details about #{person[:name]}\") DatabaseAccess.seed_database(person) # Complex test built on top of the identity that we've just seeded end I, [2023-05-15T13:34:15.480703 #75155] INFO -- : Seeding details about Bob I, [2023-05-15T13:34:15.480834 #75156] INFO -- : Seeding details about Alice I, [2023-05-15T13:34:15.481945 #75156] INFO -- : Insert successful E, [2023-05-15T13:34:15.481961 #75155] ERROR -- : Database rejected insertion, constraint violation I, [2023-05-15T13:34:15.482423 #75156] INFO -- : Seeding details about Carol I, [2023-05-15T13:34:15.482646 #75156] INFO -- : Insert successful Now, in this example we could probably have a guess based on the process ids that are visible that it was Bob that had trouble in the database, but as these things scale up the ability to confidently guess about this can become both harder and riskier. This lead to our first major requirement for Herodotus, that there should be an easy way for us to identify which scenario has logged out a specific message.\nCorralling our test cases with Correlation Ids Correlation ids are a common way to keep track of the flow of a given flow through a system, which makes them exactly what we are looking for to solve our current problem. Lets get Herodotus set up in the above example and then we will take a dive into how it works under the bonnet.\nmodule DatabaseAccess def self.seed_database(test_data) Database.add_record(test_data[:name], test_data[:dob]) end end LOGGER = DVLA::Herodotus.logger test_data = [ { name: 'Alice', dob: '14/07/1982' }, { name: 'Bob', dob: '23/01/1992' }, { name: 'Carol', dob: '09/12/1975' } ] Parallel.map(test_data, in_processes: 2) do |person| LOGGER.new_scenario(person[:name]) LOGGER.info(\"Seeding details about #{person[:name]}\") DatabaseAccess.seed_database(person) # Complex test built on top of the identity that we've just seeded end [2023-05-15 13:58:43 20e66f0f] INFO -- : Seeding details about Alice [2023-05-15 13:58:43 ab0506e8] INFO -- : Seeding details about Bob [2023-05-15 13:58:43 20e66f0f] INFO -- : Insert successful [2023-05-15 13:58:43 ab0506e8] ERROR -- : Database rejected insertion, constraint violation [2023-05-15 13:58:43 45d88073] INFO -- : Seeding details about Carol [2023-05-15 13:58:43 45d88073] INFO -- : Insert successful There are two key changes to look at here. First up, we are now creating our logger with a call to DVLA::Herodotus.logger. This will give us a Herodotus logger that is pointed at the standard output. The other thing is that, at the start of each new scenario, we are explicitly informing Herodotus that this is a new scenario for it to keep track of2. With this in place, we are able to see clearly which scenario it is that was having issues, confirming our earlier suspicious that it was Bob. Now, let’s take a look at how Herodotus manages all of these scenarios.\nmodule DVLA module Herodotus class HerodotusLogger \u003c Logger attr_accessor :system_name, :requires_pid, :merge, :correlation_ids def register_default_correlation_id @correlation_ids = { default: SecureRandom.uuid[0, 8] } reset_format end def new_scenario(scenario_id) update_format(scenario_id) merge_correlation_ids(new_scenario: scenario_id) if @merge end # Snip private def update_format(scenario_id) @correlation_ids[scenario_id] = SecureRandom.uuid[0, 8] unless @correlation_ids.key?(scenario_id) self.formatter = proc do |severity, _datetime, _progname, msg| \"[#{@system_name}\" \\ \"#{Time.now.strftime('%Y-%m-%d %H:%M:%S')} \" \\ \"#{@correlation_ids[scenario_id]}\" \\ \"#{' '.concat(Process.pid.to_s) if requires_pid}] \" \\ \"#{severity} -- : #{msg}\\n\" end end # Snip end end end Here we can see that Herodotus (which is built on top of the existing Logger class, meaning you get all the built-in functionality for free) has a Hash it uses to keep track of the correlation ids for each scenario, keyed off of the identifier that it is given with each new scenario. When new_scenario is called, the provided key is added to the hash with a new id (provided that it isn’t one that is already registered) and the format of the logger is then updated to pull through the correlation id that is associated with the provided identifier. Thus, when the logger is next called in that context, the correct correlation id will be logged out and we’ve got ourselves a nice simple way of keeping track of all our scenarios. Now, if you aren’t familiar with formatter, this is a method that exists on the default Ruby logger that lets you specify the format you want messages to be logged out in. As mentioned, Herodotus is built on top of that Logger, so we can leverage this functionality.\nThe only methods that are built into the default logger that Herodotus has any really interaction are the five logging methods (debug, info, warn, error, fatal) and even then only as a small wrapper around it that leverages the sort of metaprogramming that Ruby really excels at. This also allows you to apply a specific correlation id on a log by log basis if this is required, with the majority of the heavy lifting being handed over to the built-in Ruby class.\n%i[debug info warn error fatal].each do |log_level| define_method log_level do |progname = nil, scenario_id = nil, \u0026block| if scenario_id == nil super(progname, \u0026block) else update_format(scenario_id) super(progname, \u0026block) reset_format end end end Configuring Herodotus to suit each consumer Now, while the above logs are a great starting point, it’s also important to allow for a degree of flexibility. As such, Herodotus allows for the following configuration changes to be made:\nDVLA::Herodotus.configure do |config| config.system_name = 'person-database-testpack' config.pid = true config.merge = true end We’ll have a quick overview of the first two before taking a dive into what is going on behind the scenes with the third.\nFirst up, system_name is nice and simple. This allows you to add an overall system name to the logs that are being output. pid allows you to mimic the behaviour of the default logger, adding the process id to the output at the start of a log message. If we turn both of these on and re-run our test from before, we get an output that looks like this:\n[person-database-testpack 2023-05-15 14:59:27 683dd5bb 94910] INFO -- : Seeding details about Alice [person-database-testpack 2023-05-15 14:59:27 3425d11a 94911] INFO -- : Seeding details about Bob [person-database-testpack 2023-05-15 14:59:27 683dd5bb 94910] INFO -- : Insert successful [person-database-testpack 2023-05-15 14:59:27 3425d11a 94911] ERROR -- : Database rejected insertion, constraint violation [person-database-testpack 2023-05-15 14:59:27 709eaf7d 94910] INFO -- : Seeding details about Carol [person-database-testpack 2023-05-15 14:59:27 709eaf7d 94910] INFO -- : Insert successful Merging various instances of Herodotus together merge, the final thing that can be configured within Herodotus is the most complex. Think back to our original example, but this time imagine that rather than the database being configured in a different module, it is something we are pulling in from an external package that also implements Herodotus. Let’s have a look at what that would output:\n[person-database-testpack 2023-05-15 15:13:01 9e5ca313 98217] INFO -- : Seeding details about Alice [person-database-testpack 2023-05-15 15:13:01 d6812ffc 98218] INFO -- : Seeding details about Bob [database-gem 2023-05-15 15:13:01 fefcf70f 98217] INFO -- : Insert successful [database-gem 2023-05-15 15:13:01 99e3eb47 98218] ERROR -- : Database rejected insertion, constraint violation [person-database-testpack 2023-05-15 15:13:01 a56c4b52 98217] INFO -- : Seeding details about Carol [database-gem 2023-05-15 15:13:01 7539e3ee 98217] INFO -- : Insert successful Suddenly, we are back to the problem we originally had, were no error case can be linked back to an individual testcase. This is where merge comes in. This allows us to merge the correlation id hashes across multiple instances of Herodotus, allowing us to get consistent correlation ids. We’ve already seen what is called when merge is set to true, back when we looked at the method update_format inside Herodotus, where the method merge_correlation_ids was called if it is active. Let’s look at what that does:\ndef merge_correlation_ids(new_scenario: nil) ObjectSpace.each_object(DVLA::Herodotus::HerodotusLogger) do |logger| unless logger == self logger.merge = false if logger.merge logger.correlation_ids = self.correlation_ids logger.new_scenario(new_scenario) unless new_scenario.nil? end end end Now, the above looks complex but if we break it down it’s actually quite simple. First up, we are grabbing every instance of HerodotusLogger that currently exists by using the ObjectSpace.each_object method, which will return an enumerator that we can use to iterate through all of them. While we are iterating through them, we make sure we don’t try and merge this logger with itself, as that can lead to some nasty unexpected behaviour. Once the code is happy it has hold of a different logger, it first stops that logger from trying to merge with the others if has is set up to do so. Again, this is for safety as if that wasn’t toggled off we’d end up in an endless loop. What we actually want is a single source of truth, which will be the logger highest up the stack, in our case the one that is created in the tests. Finally, we override that loggers collection of correlation ids and then get it to set itself to the current scenario, safe in the knowledge it will have a correlation id for this scenario as we’ve just given it that.\nTaking that into account and enabling merge on our logger, we get the following output:\n[person-database-testpack 2023-05-15 15:29:47 594053ed 4415] INFO -- : Seeding details about Bob [person-database-testpack 2023-05-15 15:29:47 2472e136 4414] INFO -- : Seeding details about Alice [database-gem 2023-05-15 15:29:47 594053ed 4415] ERROR -- : Database rejected insertion, constraint violation [database-gem 2023-05-15 15:29:47 2472e136 4414] INFO -- : Insert successful [person-database-testpack 2023-05-15 15:29:47 cb266a96 4415] INFO -- : Seeding details about Carol [database-gem 2023-05-15 15:29:47 cb266a96 4415] INFO -- : Insert successful And there we have it, we are merging our ids across different instances of Herodotus allowing us trace problems as and when they arise, while also retaining the clarity that allowing each system that implements a logger to have that name reflected in all log messages. All in all, this makes for a much nicer debugging experience when something does go a bit strange in the codebase.\nMaking tests even more human-readable Right back at the start, I said that one of the most important things about these sorts of logs is that they should be easy for a human to read. As such, there is one last thing included in Herodotus that aids in that goal. There are a collection of extensions to the default String class that allow you to simple apply colour to string, helping you easily highlight specific points of interest in your log messages. With a quick pass of colour to our loggers, we can quite quickly get something that looks like this:\nLogger output, now in colour Conclusion So. that’s the story of how we came up with Herodotus. It’s by no means the most complex gem out there, but that’s no bad thing. We were looking for something pretty lightweight to extend some already quite powerful functionality within the default logger, just in a way that makes it easier for us to follow the thread through when we are perusing our logs. We’ve certainly hit that goal and have even come up with some extra functionality along the way to help with running multiple instances of Herodotus in a way that abstracts that complexity away from the consumer.\nHerodotus is named after a greek scholar and historian. One of the most famous works that Herodotus produced was the “Histories” which are some very important logs ↩︎\nWhile in this example we are giving it the name of the test data being seeded, this can be anything so long as it is unique. For example, in Cucumber we use the scenario name as an identifier. ↩︎\n","wordCount":"2156","inLanguage":"en","datePublished":"2023-05-17T00:00:00Z","dateModified":"2023-05-17T00:00:00Z","author":{"@type":"Person","name":"George Bell"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dvla.github.io/posts/2023-05-logging-with-herodotus/"},"publisher":{"@type":"Organization","name":"DVLA Engineering","logo":{"@type":"ImageObject","url":"https://dvla.github.io/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dvla.github.io/ accesskey=h title="DVLA Engineering (Alt + H)"><img src=https://dvla.github.io/favicon/apple-touch-icon.png alt aria-label=logo height=49>DVLA Engineering</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dvla.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://dvla.github.io/open-source/ title=Open-source><span>Open-source</span></a></li><li><a href=https://github.com/dvla/ title=Github><span>Github</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.civil-service-careers.gov.uk/departments/working-for-the-driver-and-vehicle-licensing-agency/ title=Careers><span>Careers</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dvla.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://dvla.github.io/posts/>Posts</a></div><h1 class=post-title>Why we wrote Herodotus</h1><div class=post-description>A look at the gem Herodotus and the problems we have been using it to solve.</div><div class=post-meta><span title='2023-05-17 00:00:00 +0000 UTC'>May 17, 2023</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;2156 words&nbsp;·&nbsp;George Bell</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#logging-to-the-standard-output-and-the-main-problem-we-faced>Logging to the standard output and the main problem we faced</a></li><li><a href=#corralling-our-test-cases-with-correlation-ids>Corralling our test cases with Correlation Ids</a></li><li><a href=#configuring-herodotus-to-suit-each-consumer>Configuring Herodotus to suit each consumer</a><ul><li><a href=#merging-various-instances-of-herodotus-together>Merging various instances of Herodotus together</a></li></ul></li><li><a href=#making-tests-even-more-human-readable>Making tests even more human-readable</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details></div><div class=post-content><p>We&rsquo;ve written Herodotus<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> as a lightweight logger to solve some very specific problems we had in our tests, but we don&rsquo;t think they are unique to us so we&rsquo;re going to share with you what we have done and why.</p><h2 id=logging-to-the-standard-output-and-the-main-problem-we-faced>Logging to the standard output and the main problem we faced<a hidden class=anchor aria-hidden=true href=#logging-to-the-standard-output-and-the-main-problem-we-faced>#</a></h2><p>The problem we are trying to solve is one of readability. All good logs are human readable, as when something has gone wrong to the point of a human needing to look in the logs and piece together what has happened we don&rsquo;t want to make that more difficult than is needed. Now, there are things out there that will help you manage your logs (for example, OpenSearch provides a fantastic toolkit for exploring a large volume of logs), these are often looking at things on a grander scale than we are. There are always going to be times where you want your system to just leave a little message wherever it is currently running, which is why we are looking at things that are logging to the standard output on whatever device they are running. Specifically in our case, we are looking at the output of an automated test pack.</p><p>Take the following code snippet, where we set up a default ruby logger and seed a database (that has access to the same global logger) for three different test scenarios, along with the output when we run it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>module</span> <span class=nn>DatabaseAccess</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>seed_database</span><span class=p>(</span><span class=n>test_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=no>Database</span><span class=o>.</span><span class=n>add_record</span><span class=p>(</span><span class=n>test_data</span><span class=o>[</span><span class=ss>:name</span><span class=o>]</span><span class=p>,</span> <span class=n>test_data</span><span class=o>[</span><span class=ss>:dob</span><span class=o>]</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=no>LOGGER</span> <span class=o>=</span> <span class=no>Logger</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=no>STDOUT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test_data</span> <span class=o>=</span> <span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>name</span><span class=p>:</span> <span class=s1>&#39;Alice&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>dob</span><span class=p>:</span> <span class=s1>&#39;14/07/1982&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>name</span><span class=p>:</span> <span class=s1>&#39;Bob&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>dob</span><span class=p>:</span> <span class=s1>&#39;23/01/1992&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>name</span><span class=p>:</span> <span class=s1>&#39;Carol&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>dob</span><span class=p>:</span> <span class=s1>&#39;09/12/1975&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=no>Parallel</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>test_data</span><span class=p>,</span> <span class=ss>in_processes</span><span class=p>:</span> <span class=mi>2</span><span class=p>)</span>  <span class=k>do</span> <span class=o>|</span><span class=n>person</span><span class=o>|</span>
</span></span><span class=line><span class=cl>  <span class=no>LOGGER</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Seeding details about </span><span class=si>#{</span><span class=n>person</span><span class=o>[</span><span class=ss>:name</span><span class=o>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=no>DatabaseAccess</span><span class=o>.</span><span class=n>seed_database</span><span class=p>(</span><span class=n>person</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1># Complex test built on top of the identity that we&#39;ve just seeded</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><pre tabindex=0><code>I, [2023-05-15T13:34:15.480703 #75155]  INFO -- : Seeding details about Bob
I, [2023-05-15T13:34:15.480834 #75156]  INFO -- : Seeding details about Alice
I, [2023-05-15T13:34:15.481945 #75156]  INFO -- : Insert successful
E, [2023-05-15T13:34:15.481961 #75155] ERROR -- : Database rejected insertion, constraint violation
I, [2023-05-15T13:34:15.482423 #75156]  INFO -- : Seeding details about Carol
I, [2023-05-15T13:34:15.482646 #75156]  INFO -- : Insert successful
</code></pre><p>Now, in this example we could probably have a guess based on the process ids that are visible that it was Bob that had trouble in the database, but as these things scale up the ability to confidently guess about this can become both harder and riskier. This lead to our first major requirement for Herodotus, that there should be an easy way for us to identify which scenario has logged out a specific message.</p><h2 id=corralling-our-test-cases-with-correlation-ids>Corralling our test cases with Correlation Ids<a hidden class=anchor aria-hidden=true href=#corralling-our-test-cases-with-correlation-ids>#</a></h2><p>Correlation ids are a common way to keep track of the flow of a given flow through a system, which makes them exactly what we are looking for to solve our current problem. Lets get Herodotus set up in the above example and then we will take a dive into how it works under the bonnet.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>module</span> <span class=nn>DatabaseAccess</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>seed_database</span><span class=p>(</span><span class=n>test_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=no>Database</span><span class=o>.</span><span class=n>add_record</span><span class=p>(</span><span class=n>test_data</span><span class=o>[</span><span class=ss>:name</span><span class=o>]</span><span class=p>,</span> <span class=n>test_data</span><span class=o>[</span><span class=ss>:dob</span><span class=o>]</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=no>LOGGER</span> <span class=o>=</span> <span class=no>DVLA</span><span class=o>::</span><span class=no>Herodotus</span><span class=o>.</span><span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test_data</span> <span class=o>=</span> <span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>name</span><span class=p>:</span> <span class=s1>&#39;Alice&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>dob</span><span class=p>:</span> <span class=s1>&#39;14/07/1982&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>name</span><span class=p>:</span> <span class=s1>&#39;Bob&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>dob</span><span class=p>:</span> <span class=s1>&#39;23/01/1992&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>name</span><span class=p>:</span> <span class=s1>&#39;Carol&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>dob</span><span class=p>:</span> <span class=s1>&#39;09/12/1975&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=no>Parallel</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>test_data</span><span class=p>,</span> <span class=ss>in_processes</span><span class=p>:</span> <span class=mi>2</span><span class=p>)</span>  <span class=k>do</span> <span class=o>|</span><span class=n>person</span><span class=o>|</span>
</span></span><span class=line><span class=cl>  <span class=no>LOGGER</span><span class=o>.</span><span class=n>new_scenario</span><span class=p>(</span><span class=n>person</span><span class=o>[</span><span class=ss>:name</span><span class=o>]</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=no>LOGGER</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Seeding details about </span><span class=si>#{</span><span class=n>person</span><span class=o>[</span><span class=ss>:name</span><span class=o>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=no>DatabaseAccess</span><span class=o>.</span><span class=n>seed_database</span><span class=p>(</span><span class=n>person</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1># Complex test built on top of the identity that we&#39;ve just seeded</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><pre tabindex=0><code>[2023-05-15 13:58:43 20e66f0f] INFO -- : Seeding details about Alice
[2023-05-15 13:58:43 ab0506e8] INFO -- : Seeding details about Bob
[2023-05-15 13:58:43 20e66f0f] INFO -- : Insert successful
[2023-05-15 13:58:43 ab0506e8] ERROR -- : Database rejected insertion, constraint violation
[2023-05-15 13:58:43 45d88073] INFO -- : Seeding details about Carol
[2023-05-15 13:58:43 45d88073] INFO -- : Insert successful
</code></pre><p>There are two key changes to look at here. First up, we are now creating our logger with a call to <code>DVLA::Herodotus.logger</code>. This will give us a Herodotus logger that is pointed at the standard output. The other thing is that, at the start of each new scenario, we are explicitly informing Herodotus that this is a new scenario for it to keep track of<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. With this in place, we are able to see clearly which scenario it is that was having issues, confirming our earlier suspicious that it was Bob. Now, let&rsquo;s take a look at how <a href=https://github.com/dvla/herodotus/blob/main/lib/dvla/herodotus/herodotus_logger.rb>Herodotus</a> manages all of these scenarios.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>module</span> <span class=nn>DVLA</span>
</span></span><span class=line><span class=cl>  <span class=k>module</span> <span class=nn>Herodotus</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>HerodotusLogger</span> <span class=o>&lt;</span> <span class=no>Logger</span>
</span></span><span class=line><span class=cl>      <span class=kp>attr_accessor</span> <span class=ss>:system_name</span><span class=p>,</span> <span class=ss>:requires_pid</span><span class=p>,</span> <span class=ss>:merge</span><span class=p>,</span> <span class=ss>:correlation_ids</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>def</span> <span class=nf>register_default_correlation_id</span>
</span></span><span class=line><span class=cl>        <span class=vi>@correlation_ids</span> <span class=o>=</span> <span class=p>{</span> <span class=ss>default</span><span class=p>:</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>uuid</span><span class=o>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>8</span><span class=o>]</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>reset_format</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>def</span> <span class=nf>new_scenario</span><span class=p>(</span><span class=n>scenario_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>update_format</span><span class=p>(</span><span class=n>scenario_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>merge_correlation_ids</span><span class=p>(</span><span class=ss>new_scenario</span><span class=p>:</span> <span class=n>scenario_id</span><span class=p>)</span> <span class=k>if</span> <span class=vi>@merge</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>      <span class=c1># Snip</span>
</span></span><span class=line><span class=cl>    <span class=kp>private</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>def</span> <span class=nf>update_format</span><span class=p>(</span><span class=n>scenario_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=vi>@correlation_ids</span><span class=o>[</span><span class=n>scenario_id</span><span class=o>]</span> <span class=o>=</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>uuid</span><span class=o>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>8</span><span class=o>]</span> <span class=k>unless</span> <span class=vi>@correlation_ids</span><span class=o>.</span><span class=n>key?</span><span class=p>(</span><span class=n>scenario_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>self</span><span class=o>.</span><span class=n>formatter</span> <span class=o>=</span> <span class=nb>proc</span> <span class=k>do</span> <span class=o>|</span><span class=n>severity</span><span class=p>,</span> <span class=n>_datetime</span><span class=p>,</span> <span class=n>_progname</span><span class=p>,</span> <span class=n>msg</span><span class=o>|</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;[</span><span class=si>#{</span><span class=vi>@system_name</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;</span><span class=si>#{</span><span class=no>Time</span><span class=o>.</span><span class=n>now</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2> &#34;</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;</span><span class=si>#{</span><span class=vi>@correlation_ids</span><span class=o>[</span><span class=n>scenario_id</span><span class=o>]</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;</span><span class=si>#{</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=no>Process</span><span class=o>.</span><span class=n>pid</span><span class=o>.</span><span class=n>to_s</span><span class=p>)</span> <span class=k>if</span> <span class=n>requires_pid</span><span class=si>}</span><span class=s2>] &#34;</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;</span><span class=si>#{</span><span class=n>severity</span><span class=si>}</span><span class=s2> -- : </span><span class=si>#{</span><span class=n>msg</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>      <span class=c1># Snip</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>Here we can see that Herodotus (which is built on top of the existing Logger class, meaning you get all the built-in functionality for free) has a Hash it uses to keep track of the correlation ids for each scenario, keyed off of the identifier that it is given with each new scenario. When <code>new_scenario</code> is called, the provided key is added to the hash with a new id (provided that it isn&rsquo;t one that is already registered) and the format of the logger is then updated to pull through the correlation id that is associated with the provided identifier. Thus, when the logger is next called in that context, the correct correlation id will be logged out and we&rsquo;ve got ourselves a nice simple way of keeping track of all our scenarios. Now, if you aren&rsquo;t familiar with <code>formatter</code>, this is <a href=https://ruby-doc.org/stdlib-2.6.4/libdoc/logger/rdoc/Logger.html#class-Logger-label-Format>a method that exists on the default Ruby logger</a> that lets you specify the format you want messages to be logged out in. As mentioned, Herodotus is built on top of that Logger, so we can leverage this functionality.</p><p>The only methods that are built into the default logger that Herodotus has any really interaction are the five logging methods (<code>debug</code>, <code>info</code>, <code>warn</code>, <code>error</code>, <code>fatal</code>) and even then only as a small wrapper around it that leverages the sort of metaprogramming that Ruby really excels at. This also allows you to apply a specific correlation id on a log by log basis if this is required, with the majority of the heavy lifting being handed over to the built-in Ruby class.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>%</span><span class=n>i</span><span class=o>[</span><span class=n>debug</span> <span class=n>info</span> <span class=nb>warn</span> <span class=n>error</span> <span class=n>fatal</span><span class=o>].</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>log_level</span><span class=o>|</span>
</span></span><span class=line><span class=cl>  <span class=n>define_method</span> <span class=n>log_level</span> <span class=k>do</span> <span class=o>|</span><span class=n>progname</span> <span class=o>=</span> <span class=kp>nil</span><span class=p>,</span> <span class=n>scenario_id</span> <span class=o>=</span> <span class=kp>nil</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>block</span><span class=o>|</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>scenario_id</span> <span class=o>==</span> <span class=kp>nil</span>
</span></span><span class=line><span class=cl>      <span class=k>super</span><span class=p>(</span><span class=n>progname</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=n>update_format</span><span class=p>(</span><span class=n>scenario_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>super</span><span class=p>(</span><span class=n>progname</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>reset_format</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h2 id=configuring-herodotus-to-suit-each-consumer>Configuring Herodotus to suit each consumer<a hidden class=anchor aria-hidden=true href=#configuring-herodotus-to-suit-each-consumer>#</a></h2><p>Now, while the above logs are a great starting point, it&rsquo;s also important to allow for a degree of flexibility. As such, Herodotus allows for the following configuration changes to be made:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>DVLA</span><span class=o>::</span><span class=no>Herodotus</span><span class=o>.</span><span class=n>configure</span> <span class=k>do</span> <span class=o>|</span><span class=n>config</span><span class=o>|</span>
</span></span><span class=line><span class=cl>  <span class=n>config</span><span class=o>.</span><span class=n>system_name</span> <span class=o>=</span> <span class=s1>&#39;person-database-testpack&#39;</span>
</span></span><span class=line><span class=cl>  <span class=n>config</span><span class=o>.</span><span class=n>pid</span> <span class=o>=</span> <span class=kp>true</span>
</span></span><span class=line><span class=cl>  <span class=n>config</span><span class=o>.</span><span class=n>merge</span> <span class=o>=</span> <span class=kp>true</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>We&rsquo;ll have a quick overview of the first two before taking a dive into what is going on behind the scenes with the third.</p><p>First up, <code>system_name</code> is nice and simple. This allows you to add an overall system name to the logs that are being output. <code>pid</code> allows you to mimic the behaviour of the default logger, adding the process id to the output at the start of a log message. If we turn both of these on and re-run our test from before, we get an output that looks like this:</p><pre tabindex=0><code>[person-database-testpack 2023-05-15 14:59:27 683dd5bb 94910] INFO -- : Seeding details about Alice
[person-database-testpack 2023-05-15 14:59:27 3425d11a 94911] INFO -- : Seeding details about Bob
[person-database-testpack 2023-05-15 14:59:27 683dd5bb 94910] INFO -- : Insert successful
[person-database-testpack 2023-05-15 14:59:27 3425d11a 94911] ERROR -- : Database rejected insertion, constraint violation
[person-database-testpack 2023-05-15 14:59:27 709eaf7d 94910] INFO -- : Seeding details about Carol
[person-database-testpack 2023-05-15 14:59:27 709eaf7d 94910] INFO -- : Insert successful
</code></pre><h3 id=merging-various-instances-of-herodotus-together>Merging various instances of Herodotus together<a hidden class=anchor aria-hidden=true href=#merging-various-instances-of-herodotus-together>#</a></h3><p><code>merge</code>, the final thing that can be configured within Herodotus is the most complex. Think back to our original example, but this time imagine that rather than the database being configured in a different module, it is something we are pulling in from an external package that also implements Herodotus. Let&rsquo;s have a look at what that would output:</p><pre tabindex=0><code>[person-database-testpack 2023-05-15 15:13:01 9e5ca313 98217] INFO -- : Seeding details about Alice
[person-database-testpack 2023-05-15 15:13:01 d6812ffc 98218] INFO -- : Seeding details about Bob
[database-gem 2023-05-15 15:13:01 fefcf70f 98217] INFO -- : Insert successful
[database-gem 2023-05-15 15:13:01 99e3eb47 98218] ERROR -- : Database rejected insertion, constraint violation
[person-database-testpack 2023-05-15 15:13:01 a56c4b52 98217] INFO -- : Seeding details about Carol
[database-gem 2023-05-15 15:13:01 7539e3ee 98217] INFO -- : Insert successful
</code></pre><p>Suddenly, we are back to the problem we originally had, were no error case can be linked back to an individual testcase. This is where <code>merge</code> comes in. This allows us to merge the correlation id hashes across multiple instances of Herodotus, allowing us to get consistent correlation ids. We&rsquo;ve already seen what is called when <code>merge</code> is set to true, back when we looked at the method <code>update_format</code> inside Herodotus, where the method <code>merge_correlation_ids</code> was called if it is active. Let&rsquo;s look at what that does:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>def</span> <span class=nf>merge_correlation_ids</span><span class=p>(</span><span class=ss>new_scenario</span><span class=p>:</span> <span class=kp>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=no>ObjectSpace</span><span class=o>.</span><span class=n>each_object</span><span class=p>(</span><span class=no>DVLA</span><span class=o>::</span><span class=no>Herodotus</span><span class=o>::</span><span class=no>HerodotusLogger</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>logger</span><span class=o>|</span>
</span></span><span class=line><span class=cl>    <span class=k>unless</span> <span class=n>logger</span> <span class=o>==</span> <span class=nb>self</span>
</span></span><span class=line><span class=cl>      <span class=n>logger</span><span class=o>.</span><span class=n>merge</span> <span class=o>=</span> <span class=kp>false</span> <span class=k>if</span> <span class=n>logger</span><span class=o>.</span><span class=n>merge</span>
</span></span><span class=line><span class=cl>      <span class=n>logger</span><span class=o>.</span><span class=n>correlation_ids</span> <span class=o>=</span> <span class=nb>self</span><span class=o>.</span><span class=n>correlation_ids</span>
</span></span><span class=line><span class=cl>      <span class=n>logger</span><span class=o>.</span><span class=n>new_scenario</span><span class=p>(</span><span class=n>new_scenario</span><span class=p>)</span> <span class=k>unless</span> <span class=n>new_scenario</span><span class=o>.</span><span class=n>nil?</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>Now, the above looks complex but if we break it down it&rsquo;s actually quite simple. First up, we are grabbing every instance of <code>HerodotusLogger</code> that currently exists by using the <a href=https://ruby-doc.org/core-2.6.1/ObjectSpace.html#method-c-each_object>ObjectSpace.each_object</a> method, which will return an enumerator that we can use to iterate through all of them. While we are iterating through them, we make sure we don&rsquo;t try and merge this logger with itself, as that can lead to some nasty unexpected behaviour. Once the code is happy it has hold of a different logger, it first stops that logger from trying to merge with the others if has is set up to do so. Again, this is for safety as if that wasn&rsquo;t toggled off we&rsquo;d end up in an endless loop. What we actually want is a single source of truth, which will be the logger highest up the stack, in our case the one that is created in the tests. Finally, we override that loggers collection of correlation ids and then get it to set itself to the current scenario, safe in the knowledge it will have a correlation id for this scenario as we&rsquo;ve just given it that.</p><p>Taking that into account and enabling merge on our logger, we get the following output:</p><pre tabindex=0><code>[person-database-testpack 2023-05-15 15:29:47 594053ed 4415] INFO -- : Seeding details about Bob
[person-database-testpack 2023-05-15 15:29:47 2472e136 4414] INFO -- : Seeding details about Alice
[database-gem 2023-05-15 15:29:47 594053ed 4415] ERROR -- : Database rejected insertion, constraint violation
[database-gem 2023-05-15 15:29:47 2472e136 4414] INFO -- : Insert successful
[person-database-testpack 2023-05-15 15:29:47 cb266a96 4415] INFO -- : Seeding details about Carol
[database-gem 2023-05-15 15:29:47 cb266a96 4415] INFO -- : Insert successful
</code></pre><p>And there we have it, we are merging our ids across different instances of Herodotus allowing us trace problems as and when they arise, while also retaining the clarity that allowing each system that implements a logger to have that name reflected in all log messages. All in all, this makes for a much nicer debugging experience when something does go a bit strange in the codebase.</p><h2 id=making-tests-even-more-human-readable>Making tests even more human-readable<a hidden class=anchor aria-hidden=true href=#making-tests-even-more-human-readable>#</a></h2><p>Right back at the start, I said that one of the most important things about these sorts of logs is that they should be easy for a human to read. As such, there is one last thing included in Herodotus that aids in that goal. There are <a href=https://github.com/dvla/herodotus/blob/main/lib/dvla/herodotus/string.rb>a collection of extensions to the default String class</a> that allow you to simple apply colour to string, helping you easily highlight specific points of interest in your log messages. With a quick pass of colour to our loggers, we can quite quickly get something that looks like this:</p><figure><img loading=lazy src=images/logger_output_in_colour.png><figcaption>Logger output, now in colour</figcaption></figure><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>So. that&rsquo;s the story of how we came up with Herodotus. It&rsquo;s by no means the most complex gem out there, but that&rsquo;s no bad thing. We were looking for something pretty lightweight to extend some already quite powerful functionality within the default logger, just in a way that makes it easier for us to follow the thread through when we are perusing our logs. We&rsquo;ve certainly hit that goal and have even come up with some extra functionality along the way to help with running multiple instances of Herodotus in a way that abstracts that complexity away from the consumer.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Herodotus is named after <a href=https://en.wikipedia.org/wiki/Herodotus>a greek scholar and historian</a>. One of the most famous works that Herodotus produced was the &ldquo;Histories&rdquo; which are some very important logs&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>While in this example we are giving it the name of the test data being seeded, this can be anything so long as it is unique. For example, in <a href=https://cucumber.io/docs/tools/ruby/>Cucumber</a> we use the scenario name as an identifier.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://dvla.github.io/tags/ruby/>Ruby</a></li><li><a href=https://dvla.github.io/tags/logging/>logging</a></li></ul><nav class=paginav><a class=prev href=https://dvla.github.io/posts/2023-05-faker-maker-initialisation/><span class=title>« Prev</span><br><span>FakerMaker Initialisation</span></a>
<a class=next href=https://dvla.github.io/posts/2023-05-testing-standard-out-in-ruby/><span class=title>Next »</span><br><span>Testing Standard-Out in Ruby</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://dvla.github.io/>DVLA Engineering</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>