<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>TiL: Save CPU cycles by logging blocks | DVLA Engineering</title><meta name=keywords content="Ruby,Logging"><meta name=description content="A look at passing blocks into loggers in Ruby."><meta name=author content="George Bell"><link rel=canonical href=https://dvla.github.io/posts/2023-12-logging-blocks/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://dvla.github.io/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dvla.github.io/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dvla.github.io/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://dvla.github.io/favicon/apple-touch-icon.png><link rel=mask-icon href=https://dvla.github.io/favicon/favicon-16x16.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://dvla.github.io/posts/2023-12-logging-blocks/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-WH4N9FEEE8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-WH4N9FEEE8")}</script><meta property="og:url" content="https://dvla.github.io/posts/2023-12-logging-blocks/"><meta property="og:site_name" content="DVLA Engineering"><meta property="og:title" content="TiL: Save CPU cycles by logging blocks"><meta property="og:description" content="A look at passing blocks into loggers in Ruby."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-15T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-15T00:00:00+00:00"><meta property="article:tag" content="Ruby"><meta property="article:tag" content="Logging"><meta property="og:image" content="https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="TiL: Save CPU cycles by logging blocks"><meta name=twitter:description content="A look at passing blocks into loggers in Ruby."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dvla.github.io/posts/"},{"@type":"ListItem","position":2,"name":"TiL: Save CPU cycles by logging blocks","item":"https://dvla.github.io/posts/2023-12-logging-blocks/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TiL: Save CPU cycles by logging blocks","name":"TiL: Save CPU cycles by logging blocks","description":"A look at passing blocks into loggers in Ruby.","keywords":["Ruby","Logging"],"articleBody":"We log a lot in our functional tests. In fact, we log so much we wrote our own logger called Herodotus that extends the default Ruby logger so we can have a correlation id added to the log to help keep track of which scenario a given log is from1. But with that much logging, we want to keep things lightweight. That’s where we want to make sure our logs aren’t doing more work than we expect.\nLog levels Log levels are great. They let you keep production logs clear of anything that doesn’t require looking at while allowing lower level environments to output verbose debugging information as required, all without having to add or remove log statements to your code as it moves between environments. In Ruby, you can control what the lowest level of logs that’ll be output in the following way:\nlogger = DVLA::Herodotus.logger logger.level = Logger::WARN In the above example, we’ve set the minimum level to warn. Let’s log some things and see what the output is:\nlogger.info('Application starting') logger.warn('DB connection timed out. Reconnecting') [2023-12-15 09:09:49 45f91875] WARN -- : DB connection timed out. Reconnecting As you can see, we’re only getting one log statement, with the info not being printed. But what does that mean under the bonnet? Let’s take a look at what happens if we pass in a more complex parameter.\nPassing parameters Consider the following code snippet:\nlogger.info(\"Current active transactions: #{TransactionCounter.count_transactions}\") Not much fancier than what we were doing previous. We’re now just interpolating the response from the method count_transactions into the message we are logging out. We don’t know what is in that method but it could be quite a costly call with lots of calculations going on behind it, so if we are in an environment where we aren’t logging anything at info level we probably don’t want to make that call. Now, suppose we add the following line somewhere in count_transactions:\nputs \"Starting transaction count\" This doesn’t change the logic in the method, but makes it nice and obvious if we’re executing the code in there. Let’s have a look at the output when we hit the log statement:\nStarting transaction count This happens because the string interpolation is happening before we get into the logger and find out that we aren’t logging at this level. So, how to prevent this?\nPassing blocks Let’s make a small change to our code:\nlogger.info { \"Current active transactions: #{TransactionCounter.count_transactions}\" } Now, we’re passing a block into the logger and the logger will, assuming it is logging out the current log level, log out the value returned by the block. The block above will return the same string as before, so let’s take a look and see if anything is logged this time:\nThat’s more like it. This time we aren’t calling count_transactions. Now, let’s take a look at why that is.\nWhereas before we were seeing the string fully interpolated before the info method was called, we’re now offloading that into the block we’re passing into the logger. As the logger is now in control of calling that block to get the value to log out, it defers doing so until it knows if it should be logging at the current level. Thus, for logs that are too low level, we don’t make any expensive calls and save a few CPU cycles.\nAll the examples in this post are written using Herodotus, but as this is functionality we’ve inherited from the built-in logger, the same principles apply there ↩︎\n","wordCount":"587","inLanguage":"en","image":"https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2023-12-15T00:00:00Z","dateModified":"2023-12-15T00:00:00Z","author":{"@type":"Person","name":"George Bell"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dvla.github.io/posts/2023-12-logging-blocks/"},"publisher":{"@type":"Organization","name":"DVLA Engineering","logo":{"@type":"ImageObject","url":"https://dvla.github.io/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dvla.github.io/ accesskey=h title="DVLA Engineering (Alt + H)"><img src=https://dvla.github.io/favicon/apple-touch-icon.png alt aria-label=logo height=49>DVLA Engineering</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dvla.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://dvla.github.io/open-source/ title=Open-source><span>Open-source</span></a></li><li><a href=https://github.com/dvla/ title=Github><span>Github</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.civil-service-careers.gov.uk/departments/working-for-the-driver-and-vehicle-licensing-agency/ title=Careers><span>Careers</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dvla.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://dvla.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">TiL: Save CPU cycles by logging blocks</h1><div class=post-description>A look at passing blocks into loggers in Ruby.</div><div class=post-meta><span title='2023-12-15 00:00:00 +0000 UTC'>December 15, 2023</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;587 words&nbsp;·&nbsp;George Bell</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#log-levels>Log levels</a></li><li><a href=#passing-parameters>Passing parameters</a></li><li><a href=#passing-blocks>Passing blocks</a></li></ul></nav></div></details></div><div class=post-content><p>We log a lot in our functional tests. In fact, we log so much we wrote our own logger called <a href=https://github.com/dvla/herodotus>Herodotus</a> that extends the default Ruby logger so we can have a correlation id added to the log to help keep track of which scenario a given log is from<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. But with that much logging, we want to keep things lightweight. That&rsquo;s where we want to make sure our logs aren&rsquo;t doing more work than we expect.</p><h2 id=log-levels>Log levels<a hidden class=anchor aria-hidden=true href=#log-levels>#</a></h2><p>Log levels are great. They let you keep production logs clear of anything that doesn&rsquo;t require looking at while allowing lower level environments to output verbose debugging information as required, all without having to add or remove log statements to your code as it moves between environments. In Ruby, you can control what the lowest level of logs that&rsquo;ll be output in the following way:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=no>DVLA</span><span class=o>::</span><span class=no>Herodotus</span><span class=o>.</span><span class=n>logger</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>level</span> <span class=o>=</span> <span class=no>Logger</span><span class=o>::</span><span class=no>WARN</span>
</span></span></code></pre></div><p>In the above example, we&rsquo;ve set the minimum level to <code>warn</code>. Let&rsquo;s log some things and see what the output is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Application starting&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>warn</span><span class=p>(</span><span class=s1>&#39;DB connection timed out. Reconnecting&#39;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>2023-12-15 09:09:49 45f91875<span class=o>]</span> WARN -- : DB connection timed out. Reconnecting
</span></span></code></pre></div><p>As you can see, we&rsquo;re only getting one log statement, with the <code>info</code> not being printed. But what does that mean under the bonnet? Let&rsquo;s take a look at what happens if we pass in a more complex parameter.</p><h2 id=passing-parameters>Passing parameters<a hidden class=anchor aria-hidden=true href=#passing-parameters>#</a></h2><p>Consider the following code snippet:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Current active transactions: </span><span class=si>#{</span><span class=no>TransactionCounter</span><span class=o>.</span><span class=n>count_transactions</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Not much fancier than what we were doing previous. We&rsquo;re now just interpolating the response from the method <code>count_transactions</code> into the message we are logging out. We don&rsquo;t know what is in that method but it could be quite a costly call with lots of calculations going on behind it, so if we are in an environment where we aren&rsquo;t logging anything at <code>info</code> level we probably don&rsquo;t want to make that call. Now, suppose we add the following line somewhere in <code>count_transactions</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>puts</span> <span class=s2>&#34;Starting transaction count&#34;</span>
</span></span></code></pre></div><p>This doesn&rsquo;t change the logic in the method, but makes it nice and obvious if we&rsquo;re executing the code in there. Let&rsquo;s have a look at the output when we hit the log statement:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Starting transaction count
</span></span></code></pre></div><p>This happens because the string interpolation is happening before we get into the logger and find out that we aren&rsquo;t logging at this level. So, how to prevent this?</p><h2 id=passing-blocks>Passing blocks<a hidden class=anchor aria-hidden=true href=#passing-blocks>#</a></h2><p>Let&rsquo;s make a small change to our code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span> <span class=p>{</span> <span class=s2>&#34;Current active transactions: </span><span class=si>#{</span><span class=no>TransactionCounter</span><span class=o>.</span><span class=n>count_transactions</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span></code></pre></div><p>Now, we&rsquo;re passing a block into the logger and the logger will, assuming it is logging out the current log level, log out the value returned by the block. The block above will return the same string as before, so let&rsquo;s take a look and see if anything is logged this time:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl> 
</span></span></code></pre></div><p>That&rsquo;s more like it. This time we aren&rsquo;t calling <code>count_transactions</code>. Now, let&rsquo;s take a look at why that is.</p><p>Whereas before we were seeing the string fully interpolated before the <code>info</code> method was called, we&rsquo;re now offloading that into the block we&rsquo;re passing into the logger. As the logger is now in control of calling that block to get the value to log out, it defers doing so until it knows if it should be logging at the current level. Thus, for logs that are too low level, we don&rsquo;t make any expensive calls and save a few CPU cycles.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>All the examples in this post are written using Herodotus, but as this is functionality we&rsquo;ve inherited from the built-in logger, the same principles apply there&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://dvla.github.io/tags/ruby/>Ruby</a></li><li><a href=https://dvla.github.io/tags/logging/>Logging</a></li></ul><nav class=paginav><a class=prev href=https://dvla.github.io/posts/2024-03-streamline-application-processing/><span class=title>« Prev</span><br><span>How AWS Step Functions helped streamline the DVLA's application process</span>
</a><a class=next href=https://dvla.github.io/posts/2023-12-spring-security-aws-kms/><span class=title>Next »</span><br><span>Spring Security private key jwt with AWS KMS</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://dvla.github.io/>DVLA Engineering</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>