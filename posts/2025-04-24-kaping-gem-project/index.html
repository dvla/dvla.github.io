<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>KA-PING! a gem to integrated with Elastic and OpenSearch | DVLA Engineering</title><meta name=keywords content="Ruby,ElasticSearch,OpenSearch"><meta name=description content="Idiomatic may to build complex OpenSearch queries in Ruby."><meta name=author content="Kevin Upstill"><link rel=canonical href=https://dvla.github.io/posts/2025-04-24-kaping-gem-project/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://dvla.github.io/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dvla.github.io/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dvla.github.io/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://dvla.github.io/favicon/apple-touch-icon.png><link rel=mask-icon href=https://dvla.github.io/favicon/favicon-16x16.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://dvla.github.io/posts/2025-04-24-kaping-gem-project/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-WH4N9FEEE8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-WH4N9FEEE8")}</script><meta property="og:url" content="https://dvla.github.io/posts/2025-04-24-kaping-gem-project/"><meta property="og:site_name" content="DVLA Engineering"><meta property="og:title" content="KA-PING! a gem to integrated with Elastic and OpenSearch"><meta property="og:description" content="Idiomatic may to build complex OpenSearch queries in Ruby."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-24T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-24T00:00:00+00:00"><meta property="article:tag" content="Ruby, ElasticSearch, OpenSearch"><meta property="og:image" content="https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="KA-PING! a gem to integrated with Elastic and OpenSearch"><meta name=twitter:description content="Idiomatic may to build complex OpenSearch queries in Ruby."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dvla.github.io/posts/"},{"@type":"ListItem","position":2,"name":"KA-PING! a gem to integrated with Elastic and OpenSearch","item":"https://dvla.github.io/posts/2025-04-24-kaping-gem-project/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"KA-PING! a gem to integrated with Elastic and OpenSearch","name":"KA-PING! a gem to integrated with Elastic and OpenSearch","description":"Idiomatic may to build complex OpenSearch queries in Ruby.","keywords":["Ruby, ElasticSearch, OpenSearch"],"articleBody":"You can only stretch elastic so far before it goes KA-PING!\nThe starting point for creating a new DVLA gem to integrate with AWS OpenSearch and ElasticSearch was the amount of documentation there is surrounding the technology. There is a lot for a reason, it’s a very powerful and useful tool, but the flip side is the learning curve involved in understanding all the features and query structure.\nOur use case is we wanted squads to have a simple way to retrieve specific driver test data to use in their tests without having to fully understand Elasticsearch and all its capabilities.\nA lot of our tests require very specific data requirements which can result in complex search queries with multiple parameters and search terms to consider. The code to write these complex queries can ballon into a very deep nested JSON.\nOut test platform architecture is based on Ruby, so we wanted a Ruby way to write large queries easily, which lead to the development of a query builder using the dot notation concept to chain the queries terms together.\nWe didn’t need every aspect of the full OpenSearch capabilities to begin with, so we started with a sub set of search terms which we commonly use. With this in mind there is further development work to cover more of the OpensSearch functions down the line.\nThe Ka-Ping Ruby Gem The Ka-Ping Ruby Gem enables the user to build complex ElasticSearch DSL Queries for searching and filtering large data sets without having to worry about formatting the JSON payloads.\nUsing intuitive search terms and operations, it’s easier to construct human-readable search definitions without needing a deep understanding of the Query DSL syntax.\nComplex search term query looks like with JSON notation Probably the best way to demonstrate Kaping is to look at the traditional query construct, then the Kaping way.\nTraditional JSON query def multi date = DateTime.now.strftime('%Y-%m-%d') query = { query: { bool: { must: [ { match_phrase: { 'fruit.destination': 'Market' } }, { match_phrase: { 'fruit.code': 'LA-MOP' } }, { match_phrase: { fruitStatus: 'Ripe' } }, { match_phrase: { 'current.address.first_line': 'Plantation Row' } }, { match: { 'fruit.category': 'Tropical' } }, { range: { 'fruit.pickedDate' =\u003e { gte: '2025-08-21', lte: date } } }, { range: { 'fruit.inspection.taken' =\u003e { gte: date } } }, { range: { 'fruit.importDate' =\u003e { gte: date } } }, ], must_not: [{ exists: { field: 'fruitEndDate' } }, { exists: { field: 'fruit.import.USATariffs' } }, { exists: { field: 'fruit.status.goneBad' } }, { match_phrase: { 'fruit.category': { query: 'B A NN NA AN', operator: 'or' } } }, { wildcard: { 'fruit.address.import.code': 'NIT*' } }, { wildcard: { 'fruit.address.import.code': 'NAT*' } }, { wildcard: { 'fruit.address.import.code': 'NOO*' } }], filter: { term: { 'licence.fruit': 'Valid' } }, }, match: { 'fruit.type': 'Tropical' }, }, } end In the above example the nested JSON can become quite a handful, Kaping solves this by making the code more human readable.\nWhat the query looks likes with Kaping def multi date = DateTime.now.strftime('%Y-%m-%d') q = DVLA::Kaping::Query.new('bool') q.must.match('fruit.destination', 'Market'). match_phrase('fruit.code', 'LA-MOP'). match_phrase('fruitStatus', 'Ripe'). match_phrase('current.address.first_line', 'Plantation Row'). between('fruit.pickedDate', '2025-08-21', date.to_s). between('fruit.inspection.taken', '2025-08-21', date.to_s). between('fruit.importDate', '2025-08-21', date.to_s). match('fruit.category', 'Tropical') q.must_not. exists('field', 'fruitEndDate'). exists('field', 'fruit.import.USATariffs'). exists('field', 'fruit.status.goneBad'). match_phrase('fruit.category', query: 'B A NN NA AN', operator: 'or'). wildcard('fruit.address.import.code', 'NIT*'). wildcard('fruit.address.import.code', 'NAT*'). wildcard('fruit.address.import.code', 'NOO*'). filter('licence.fruit', 'Valid') q.to_json end The key point here is you don’t need to worry about the nested JSON structure, the naming convention is intuitive and closely resembles the OpenSearch syntax.\nLet’s break that down further\nmy_query = DVLA::Kaping::Query.new('bool') This is the starting point for creating a query definition by calling an instance of the Kaping:: Query class and assigning it to a variable, e.g. ‘my_query’\nWe then set the type of query we want. The common ones are ‘bool’ or ‘match’ depending on your search context.\nIf don’t require a complex query you could do a very basic match query:\nmy_query = DVLA::Kaping::Query.new('match_phrase', foo: 'Bar') my_query.to_json this is equivalent to writing this query in JSON\nmy_query = { \"query\": { \"match_phrase\": { \"foo\": \"Bar\" } } } With Kaping the JSON formation and formatting is taken care of with the common Ruby call .to_json\nIn the large example above, each line is a new search term definition. There are various different terms you can use depending on what functionality you require. You can group these terms in positive or negative boolean operations.\nCurrent sub list of terms are: match_phrase - match documents that contain an exact phrase match - full-text search on a specific document field exist - search for documents that contain a specific field. wildcard - match a wildcard pattern, such as He**o term - search for exact term in a field. prefix - search for terms that begin with a specific prefix regex - search for terms that match a regular expression, eg “[a-zA-Z]amlet” between - search for a range of values in a field These are a mix of full-text queries and term-level queries, but they are most commonly use for our kind of searches, other can easily be added as requirements dictate.\nThe next part is the data field you want to search on\nDVLA::Kaping::Query.new(‘match_phrase’, foo: ‘Bar’)\nThen the last part is the data you are looking for, the data type can be a range, exact match string, regex or a filter for example\nDVLA::Kaping::Query.new(‘match_phrase’, foo: ’ Bar’)\nConfiguration The Gem can be configured through a ‘kaping.yml’ file. Such configs as the logging level, result size and the AWS configs can be set in the yaml, The config file can also be used to pick up any environment settings which is useful if running in a CI pipeline.\nThe Client Currently we have a AWS OpenSearch client which takes care of the Sig4C signing. The AWS credentials can either be supplied as ENV variables or through a profile.\nSearch As long as your client is configure you can also use the optional built-in search facility\nmy_query = DVLA::Kaping::Query.new('match_phrase', foo: 'Bar') my_query.to_json response = DVLA::Kaping.search(my_query) response.dig('hits', 'hits') Opens Source External link to Kaping in rubygems\nWe wanted to open source this Ruby Gem to a wider audiance so that others can also benefit from simplifying their OpenSearch queries. We also embrace the feedback to further enhance the Gem and increase it’s scope.\nFurther Development As mentioned before, not all the functionality of OpenSearch has been implemented, but any requests to expand will be taken into consideration. The code base for Kaping is small, the query builder is 40 lines of code. The separation of terms into their own module makes it easy to add additional query terms as required.\n","wordCount":"1107","inLanguage":"en","image":"https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-04-24T00:00:00Z","dateModified":"2025-04-24T00:00:00Z","author":{"@type":"Person","name":"Kevin Upstill"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dvla.github.io/posts/2025-04-24-kaping-gem-project/"},"publisher":{"@type":"Organization","name":"DVLA Engineering","logo":{"@type":"ImageObject","url":"https://dvla.github.io/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dvla.github.io/ accesskey=h title="DVLA Engineering (Alt + H)"><img src=https://dvla.github.io/favicon/apple-touch-icon.png alt aria-label=logo height=49>DVLA Engineering</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dvla.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://dvla.github.io/open-source/ title=Open-source><span>Open-source</span></a></li><li><a href=https://github.com/dvla/ title=Github><span>Github</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.civil-service-careers.gov.uk/departments/working-for-the-driver-and-vehicle-licensing-agency/ title=Careers><span>Careers</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dvla.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://dvla.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">KA-PING! a gem to integrated with Elastic and OpenSearch</h1><div class=post-description>Idiomatic may to build complex OpenSearch queries in Ruby.</div><div class=post-meta><span title='2025-04-24 00:00:00 +0000 UTC'>April 24, 2025</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1107 words&nbsp;·&nbsp;Kevin Upstill</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#the-ka-ping-ruby-gem>The Ka-Ping Ruby Gem</a><ul><li><a href=#complex-search-term-query-looks-like-with-json-notation>Complex search term query looks like with JSON notation</a></li></ul></li><li><a href=#configuration>Configuration</a></li><li><a href=#the-client>The Client</a></li><li><a href=#search>Search</a></li><li><a href=#opens-source>Opens Source</a></li><li><a href=#further-development>Further Development</a></li></ul></nav></div></details></div><div class=post-content><p><em><strong>You can only stretch elastic so far before it goes KA-PING!</strong></em></p><p>The starting point for creating a new DVLA gem to integrate with AWS OpenSearch and ElasticSearch was the amount of documentation
there is surrounding the technology. There is a lot for a reason, it&rsquo;s a very powerful and useful tool,
but the flip side is the learning curve involved in understanding all the features and query structure.</p><p>Our use case is we wanted squads to have a simple way to retrieve specific driver test data to use in their
tests without having to fully understand Elasticsearch and all its capabilities.</p><p>A lot of our tests require very specific data requirements which can result in complex search queries with multiple parameters and
search terms to consider. The code to write these complex queries can ballon into a very deep nested JSON.</p><p>Out test platform architecture is based on Ruby, so we wanted a Ruby way to write large queries easily, which lead to the
development of a query builder using the dot notation concept to chain the queries terms together.</p><p>We didn&rsquo;t need every aspect of the full OpenSearch capabilities to begin with, so we started with a sub set of search terms
which we commonly use. With this in mind there is further development work to cover more of the OpensSearch functions down the line.</p><h2 id=the-ka-ping-ruby-gem>The Ka-Ping Ruby Gem<a hidden class=anchor aria-hidden=true href=#the-ka-ping-ruby-gem>#</a></h2><p>The Ka-Ping Ruby Gem enables the user to build complex ElasticSearch DSL Queries for searching and filtering large data sets without
having to worry about formatting the JSON payloads.</p><p>Using intuitive search terms and operations, it&rsquo;s easier to construct human-readable search definitions without needing a deep
understanding of the Query DSL syntax.</p><h3 id=complex-search-term-query-looks-like-with-json-notation>Complex search term query looks like with JSON notation<a hidden class=anchor aria-hidden=true href=#complex-search-term-query-looks-like-with-json-notation>#</a></h3><p>Probably the best way to demonstrate Kaping is to look at the traditional query construct, then the Kaping way.</p><h4 id=traditional-json-query>Traditional JSON query<a hidden class=anchor aria-hidden=true href=#traditional-json-query>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>multi</span>
</span></span><span class=line><span class=cl>  <span class=n>date</span> <span class=o>=</span> <span class=no>DateTime</span><span class=o>.</span><span class=n>now</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-%d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>query</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=ss>query</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=ss>bool</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=ss>must</span><span class=p>:</span> <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=ss>match_phrase</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.destination&#39;</span><span class=p>:</span> <span class=s1>&#39;Market&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=ss>match_phrase</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.code&#39;</span><span class=p>:</span> <span class=s1>&#39;LA-MOP&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=ss>match_phrase</span><span class=p>:</span> <span class=p>{</span> <span class=ss>fruitStatus</span><span class=p>:</span> <span class=s1>&#39;Ripe&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=ss>match_phrase</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;current.address.first_line&#39;</span><span class=p>:</span> <span class=s1>&#39;Plantation Row&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=ss>match</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.category&#39;</span><span class=p>:</span> <span class=s1>&#39;Tropical&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=ss>range</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.pickedDate&#39;</span> <span class=o>=&gt;</span> <span class=p>{</span> <span class=ss>gte</span><span class=p>:</span> <span class=s1>&#39;2025-08-21&#39;</span><span class=p>,</span> <span class=ss>lte</span><span class=p>:</span> <span class=n>date</span> <span class=p>}</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=ss>range</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.inspection.taken&#39;</span> <span class=o>=&gt;</span> <span class=p>{</span> <span class=ss>gte</span><span class=p>:</span> <span class=n>date</span> <span class=p>}</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=ss>range</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.importDate&#39;</span> <span class=o>=&gt;</span> <span class=p>{</span> <span class=ss>gte</span><span class=p>:</span> <span class=n>date</span> <span class=p>}</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=ss>must_not</span><span class=p>:</span> <span class=o>[</span><span class=p>{</span> <span class=ss>exists</span><span class=p>:</span> <span class=p>{</span> <span class=ss>field</span><span class=p>:</span> <span class=s1>&#39;fruitEndDate&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                   <span class=p>{</span> <span class=ss>exists</span><span class=p>:</span> <span class=p>{</span> <span class=ss>field</span><span class=p>:</span> <span class=s1>&#39;fruit.import.USATariffs&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                   <span class=p>{</span> <span class=ss>exists</span><span class=p>:</span> <span class=p>{</span> <span class=ss>field</span><span class=p>:</span> <span class=s1>&#39;fruit.status.goneBad&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                   <span class=p>{</span> <span class=ss>match_phrase</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.category&#39;</span><span class=p>:</span> <span class=p>{</span> <span class=ss>query</span><span class=p>:</span> <span class=s1>&#39;B A NN NA AN&#39;</span><span class=p>,</span> <span class=ss>operator</span><span class=p>:</span> <span class=s1>&#39;or&#39;</span> <span class=p>}</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                   <span class=p>{</span> <span class=ss>wildcard</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.address.import.code&#39;</span><span class=p>:</span> <span class=s1>&#39;NIT*&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                   <span class=p>{</span> <span class=ss>wildcard</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.address.import.code&#39;</span><span class=p>:</span> <span class=s1>&#39;NAT*&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                   <span class=p>{</span> <span class=ss>wildcard</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.address.import.code&#39;</span><span class=p>:</span> <span class=s1>&#39;NOO*&#39;</span> <span class=p>}</span> <span class=p>}</span><span class=o>]</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=ss>filter</span><span class=p>:</span> <span class=p>{</span> <span class=ss>term</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;licence.fruit&#39;</span><span class=p>:</span> <span class=s1>&#39;Valid&#39;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=ss>match</span><span class=p>:</span> <span class=p>{</span> <span class=s1>&#39;fruit.type&#39;</span><span class=p>:</span> <span class=s1>&#39;Tropical&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>In the above example the nested JSON can become quite a handful, Kaping solves this by making the code more human readable.</p><h4 id=what-the-query-looks-likes-with-kaping>What the query looks likes with Kaping<a hidden class=anchor aria-hidden=true href=#what-the-query-looks-likes-with-kaping>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>def</span> <span class=nf>multi</span>
</span></span><span class=line><span class=cl>  <span class=n>date</span> <span class=o>=</span> <span class=no>DateTime</span><span class=o>.</span><span class=n>now</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-%d&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>q</span> <span class=o>=</span> <span class=no>DVLA</span><span class=o>::</span><span class=no>Kaping</span><span class=o>::</span><span class=no>Query</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;bool&#39;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  <span class=n>q</span><span class=o>.</span><span class=n>must</span><span class=o>.</span><span class=n>match</span><span class=p>(</span><span class=s1>&#39;fruit.destination&#39;</span><span class=p>,</span> <span class=s1>&#39;Market&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>match_phrase</span><span class=p>(</span><span class=s1>&#39;fruit.code&#39;</span><span class=p>,</span> <span class=s1>&#39;LA-MOP&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>match_phrase</span><span class=p>(</span><span class=s1>&#39;fruitStatus&#39;</span><span class=p>,</span> <span class=s1>&#39;Ripe&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>match_phrase</span><span class=p>(</span><span class=s1>&#39;current.address.first_line&#39;</span><span class=p>,</span> <span class=s1>&#39;Plantation Row&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>between</span><span class=p>(</span><span class=s1>&#39;fruit.pickedDate&#39;</span><span class=p>,</span> <span class=s1>&#39;2025-08-21&#39;</span><span class=p>,</span> <span class=n>date</span><span class=o>.</span><span class=n>to_s</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>between</span><span class=p>(</span><span class=s1>&#39;fruit.inspection.taken&#39;</span><span class=p>,</span> <span class=s1>&#39;2025-08-21&#39;</span><span class=p>,</span> <span class=n>date</span><span class=o>.</span><span class=n>to_s</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>between</span><span class=p>(</span><span class=s1>&#39;fruit.importDate&#39;</span><span class=p>,</span> <span class=s1>&#39;2025-08-21&#39;</span><span class=p>,</span> <span class=n>date</span><span class=o>.</span><span class=n>to_s</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>match</span><span class=p>(</span><span class=s1>&#39;fruit.category&#39;</span><span class=p>,</span> <span class=s1>&#39;Tropical&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>q</span><span class=o>.</span><span class=n>must_not</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>exists</span><span class=p>(</span><span class=s1>&#39;field&#39;</span><span class=p>,</span> <span class=s1>&#39;fruitEndDate&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>exists</span><span class=p>(</span><span class=s1>&#39;field&#39;</span><span class=p>,</span> <span class=s1>&#39;fruit.import.USATariffs&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>exists</span><span class=p>(</span><span class=s1>&#39;field&#39;</span><span class=p>,</span> <span class=s1>&#39;fruit.status.goneBad&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>match_phrase</span><span class=p>(</span><span class=s1>&#39;fruit.category&#39;</span><span class=p>,</span>  <span class=ss>query</span><span class=p>:</span> <span class=s1>&#39;B A NN NA AN&#39;</span><span class=p>,</span> <span class=ss>operator</span><span class=p>:</span> <span class=s1>&#39;or&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>wildcard</span><span class=p>(</span><span class=s1>&#39;fruit.address.import.code&#39;</span><span class=p>,</span> <span class=s1>&#39;NIT*&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>wildcard</span><span class=p>(</span><span class=s1>&#39;fruit.address.import.code&#39;</span><span class=p>,</span> <span class=s1>&#39;NAT*&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>wildcard</span><span class=p>(</span><span class=s1>&#39;fruit.address.import.code&#39;</span><span class=p>,</span> <span class=s1>&#39;NOO*&#39;</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>filter</span><span class=p>(</span><span class=s1>&#39;licence.fruit&#39;</span><span class=p>,</span> <span class=s1>&#39;Valid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>q</span><span class=o>.</span><span class=n>to_json</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>The key point here is you don&rsquo;t need to worry about the nested JSON structure, the naming convention is intuitive and closely resembles
the OpenSearch syntax.</p><p>Let&rsquo;s break that down further</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Ruby data-lang=Ruby><span class=line><span class=cl><span class=n>my_query</span> <span class=o>=</span> <span class=no>DVLA</span><span class=o>::</span><span class=no>Kaping</span><span class=o>::</span><span class=no>Query</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;bool&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>This is the starting point for creating a query definition by calling an instance of the Kaping:: Query
class and assigning it to a variable, e.g. &lsquo;my_query&rsquo;</p><p>We then set the type of query we want. The common ones are &lsquo;bool&rsquo; or &lsquo;match&rsquo;
depending on your search context.</p><p>If don&rsquo;t require a complex query you could do a very basic match query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Ruby data-lang=Ruby><span class=line><span class=cl><span class=n>my_query</span> <span class=o>=</span> <span class=no>DVLA</span><span class=o>::</span><span class=no>Kaping</span><span class=o>::</span><span class=no>Query</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;match_phrase&#39;</span><span class=p>,</span> <span class=ss>foo</span><span class=p>:</span> <span class=s1>&#39;Bar&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>my_query</span><span class=o>.</span><span class=n>to_json</span>
</span></span></code></pre></div><p>this is equivalent to writing this query in JSON</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Ruby data-lang=Ruby><span class=line><span class=cl><span class=n>my_query</span> <span class=o>=</span> <span class=p>{</span> <span class=s2>&#34;query&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>               <span class=p>{</span> <span class=s2>&#34;match_phrase&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                   <span class=p>{</span> <span class=s2>&#34;foo&#34;</span><span class=p>:</span> <span class=s2>&#34;Bar&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>               <span class=p>}</span>
</span></span><span class=line><span class=cl>           <span class=p>}</span>
</span></span></code></pre></div><p>With Kaping the JSON formation and formatting is taken care of with the common Ruby call .to_json</p><p>In the large example above, each line is a new search term definition. There are various different terms you can use depending on what
functionality you require. You can group these terms in positive or negative boolean operations.</p><h4 id=current-sub-list-of-terms-are>Current sub list of terms are:<a hidden class=anchor aria-hidden=true href=#current-sub-list-of-terms-are>#</a></h4><ul><li><strong>match_phrase</strong> - match documents that contain an exact phrase</li><li><strong>match</strong> - full-text search on a specific document field</li><li><strong>exist</strong> - search for documents that contain a specific field.</li><li><strong>wildcard</strong> - match a wildcard pattern, such as He**o</li><li><strong>term</strong> - search for exact term in a field.</li><li><strong>prefix</strong> - search for terms that begin with a specific prefix</li><li><strong>regex</strong> - search for terms that match a regular expression, eg &ldquo;[a-zA-Z]amlet&rdquo;</li><li><strong>between</strong> - search for a range of values in a field</li></ul><p>These are a mix of full-text queries and term-level queries, but they are most commonly use for our kind of searches,
other can easily be added as requirements dictate.</p><p>The next part is the data field you want to search on</p><blockquote><p>DVLA::Kaping::Query.new(&lsquo;match_phrase&rsquo;, <strong>foo</strong>: &lsquo;Bar&rsquo;)</p></blockquote><p>Then the last part is the data you are looking for, the data type can be a range, exact match string, regex or a filter for example</p><blockquote><p>DVLA::Kaping::Query.new(&lsquo;match_phrase&rsquo;, foo: <strong>&rsquo; Bar&rsquo;</strong>)</p></blockquote><h2 id=configuration>Configuration<a hidden class=anchor aria-hidden=true href=#configuration>#</a></h2><p>The Gem can be configured through a &lsquo;kaping.yml&rsquo; file. Such configs as the logging level, result size and the AWS configs
can be set in the yaml, The config file can also be used to pick up any environment settings which is useful if running
in a CI pipeline.</p><h2 id=the-client>The Client<a hidden class=anchor aria-hidden=true href=#the-client>#</a></h2><p>Currently we have a AWS OpenSearch client which takes care of the Sig4C signing. The AWS credentials can either be supplied
as ENV variables or through a profile.</p><h2 id=search>Search<a hidden class=anchor aria-hidden=true href=#search>#</a></h2><p>As long as your client is configure you can also use the optional built-in search facility</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>my_query</span> <span class=o>=</span> <span class=no>DVLA</span><span class=o>::</span><span class=no>Kaping</span><span class=o>::</span><span class=no>Query</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;match_phrase&#39;</span><span class=p>,</span> <span class=ss>foo</span><span class=p>:</span> <span class=s1>&#39;Bar&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>my_query</span><span class=o>.</span><span class=n>to_json</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=no>DVLA</span><span class=o>::</span><span class=no>Kaping</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>my_query</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>response</span><span class=o>.</span><span class=n>dig</span><span class=p>(</span><span class=s1>&#39;hits&#39;</span><span class=p>,</span> <span class=s1>&#39;hits&#39;</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=opens-source>Opens Source<a hidden class=anchor aria-hidden=true href=#opens-source>#</a></h2><p><a href=https://rubygems.org/gems/dvla-kaping>External link to Kaping in rubygems</a></p><p>We wanted to open source this Ruby Gem to a wider audiance so that others can also benefit from simplifying their OpenSearch queries. We also
embrace the feedback to further enhance the Gem and increase it&rsquo;s scope.</p><h2 id=further-development>Further Development<a hidden class=anchor aria-hidden=true href=#further-development>#</a></h2><p>As mentioned before, not all the functionality of OpenSearch has been implemented, but any requests to expand will be taken into consideration.
The code base for Kaping is small, the query builder is 40 lines of code. The separation of terms into their own module makes it easy to
add additional query terms as required.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://dvla.github.io/tags/ruby-elasticsearch-opensearch/>Ruby, ElasticSearch, OpenSearch</a></li></ul><nav class=paginav><a class=prev href=https://dvla.github.io/posts/2025-06-09-double-splat-nil/><span class=title>« Prev</span><br><span>TiL: Double Splat Nil in Ruby</span>
</a><a class=next href=https://dvla.github.io/posts/2025-04-04-experimenting-with-rag-llm/><span class=title>Next »</span><br><span>Experimenting with Retrieval Augmented Generation (RAG) with LLMs</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://dvla.github.io/>DVLA Engineering</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>