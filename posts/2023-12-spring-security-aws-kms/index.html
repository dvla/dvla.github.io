<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Spring Security private key jwt with AWS KMS | DVLA Engineering</title><meta name=keywords content="spring,AWS"><meta name=description content="How to configure spring security to use private key jwt with AWS KMS"><meta name=author content="Greg Simons"><link rel=canonical href=https://dvla.github.io/posts/2023-12-spring-security-aws-kms/><link crossorigin=anonymous href=/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css integrity="sha256-IhHKMWS+eDACT2qtKzouUghDpk+PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as=style><link rel=icon href=https://dvla.github.io/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dvla.github.io/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dvla.github.io/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://dvla.github.io/favicon/apple-touch-icon.png><link rel=mask-icon href=https://dvla.github.io/favicon/favicon-16x16.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://dvla.github.io/posts/2023-12-spring-security-aws-kms/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-WH4N9FEEE8"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-WH4N9FEEE8")}</script><meta property="og:url" content="https://dvla.github.io/posts/2023-12-spring-security-aws-kms/"><meta property="og:site_name" content="DVLA Engineering"><meta property="og:title" content="Spring Security private key jwt with AWS KMS"><meta property="og:description" content="How to configure spring security to use private key jwt with AWS KMS"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-05T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-05T00:00:00+00:00"><meta property="article:tag" content="Spring"><meta property="article:tag" content="AWS"><meta property="og:image" content="https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Spring Security private key jwt with AWS KMS"><meta name=twitter:description content="How to configure spring security to use private key jwt with AWS KMS"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dvla.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Spring Security private key jwt with AWS KMS","item":"https://dvla.github.io/posts/2023-12-spring-security-aws-kms/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Security private key jwt with AWS KMS","name":"Spring Security private key jwt with AWS KMS","description":"How to configure spring security to use private key jwt with AWS KMS","keywords":["spring","AWS"],"articleBody":"As part of our proof of concepts in to the adoption of One Login we setup a Spring Security OAuth 2.0 demo that tested out the integration guide provided by Government Digital Service (GDS).\nSpring security has long had great OAuth2.0 support from both the server and client elements. Over the last year spring security added support for the private_key_jwt client authentication method as part of the authorization code grant flow. Spring Security GitHub ref\nThe configuration for the key signing requires both the public and private key to be available to the application. Key Management Service (KMS) by Amazon Web Services (AWS) provides services to centrally manage your keys for encryption and signing and is an option to allow a more centralised mechanism for key rotation and policy management.\nIn order to add this support in to Spring it requires a number of customisations to be made which will be explained in this post. If your AuthZ server also supports elliptic-curve digital signature algorithms (ECDSA) for the ID token I will outline the additional Bean configuration required as Spring security defaults to RS256 supported with RSA keys.\nprivate_key_jwt The private key jwt client authentication method requires a jwt token to be sent alongside client id, code as a client assertion to the token endpoint. This jwt will need to be signed and then sent in a client_assertion parameter to the auth server. A number of algorithms are supported by various auth servers and can be found by visiting the configuration endpoint of the auth server.\nFull details of the spec can be found here rfc 7523\nThe first configuration change required is to switch out the default access token response client as part of the HttpSecurity config. This provides the ability to customise the token endpoint request parameters to enrich with the client assertion signed by kms.\n@Bean public Security FilterChain filterchain(HttpSecurity http) throws Exception { .... http.oauth2Login(oauth2Login -\u003e oauthLogin.tokenEndpoint(tokenEndpoint -\u003e tokenEndpoint.accessTokenResponseClient(accessTokenResponseClient))). .oauth2Client.authorizationCodeGrant(authorizationCodeGrant -\u003e authorizationCodeGrant.accessTokenResponseClient(accessTokenResponseClient))); .... http.build(); } OAuth2AccessTokenResponseClient In order to override the request entity handling to add support for the kms signing you need to add a custom request entity converter to the access token response client that you create.\n... @Bean public OAuth2AccessTokenResponseClient\u003cOAuthAuthorizationCodeGrantRequest accessTokenResponseClient() { .... DefaultAuthorizationCodeTokenResponseClient client = new DefaultAuthorizationCodeTokenResponseClient(); client.setRequestEntityConverter(converter); return client; } From this point it is now necessary to create the converter:\nIt is important to note whether or not you are creating the beans or are they being managed and created by Spring as you could incur a number of errors if the objects are manually instantiated. The converter is the main class that allows the overriding of the request parameters.\n@Component public class CustomKMSJWTClientAuthNConverter implements Converter\u003cOAuth2AuthorizationCodeGrantRequest, RequestEntity\u003c?\u003e\u003e { private OAuth2AuthorizationCodeGrantRequestEntityConverter defaultConverter; public CustomKMSJWTClientAuthNConverter () { defaultConverter = new OAuth2AuthorizationCodeGrantRequestEntityConverter(); } public RequestEntity\u003c?\u003e convert(OAuth2AuthorizationCodeGrantRequest req) { String signedJWT = createSignedJwt(); RequestEntity\u003c?\u003e entity = defaultConverter.convert(req); MultiValueMap\u003cString, String\u003e parameters = (MultiValueMap\u003cString, String\u003e) entity.getBody(); parameters.set(\"client_assertion_type\", \"urn:ietf:params:oauth:client-assertion-type:jwt-bearer\"); parameters.set(\"client_assertion\", signedJWT); return new RequestEntity\u003c\u003e(parameters, entity.getHeaders(), entity.getMethod(), entity.getUrl()); } } Creating a signed JWT The next step is to create the JWT and use the KMS API to sign the token.\nYou will need to setup the AWS SDK and KMS Client. For example, I exported the AWS_SECRET_ACCESS_KEY, AWS_SESSION_TOKEN and AWS_ACCESS_KEY_ID environment variables and set them on the command line. There are a number of alternatives supported in spring that can be found here: AWS SDK on Spring\nkmsClient = KmsClient.builder().region(Region.of(\".....\")) .credentialsProvider(DefaultCredentialsProvider.create() .build(); // tbc values can be configured with your auth server public String createSignedJwt() { JWTClaimSet.Builder claimSetBuilder = new JWTClaimSet.Builder().audience('tbc').issuer('tbc').subject('tbc').expirationTime(tbc).issueTime(Date.from(Instant.now())).jwtId('tbc'); JWTClaimSet claimSet = claimSetBuilder.build(); return sign(claimSet); } We now have a JWT token ready to sign and verify with KMS.\npublic String sign(JWTClaimSet claimSet) { .... // choose a token alg based on what is supported by your auth Server JWSHeader header = new JWSHeader(TOKEN_ALG); Base64URL encodedHeader = header.toBase64URL(); Base64URL encodedClaims = Base64URL.encode(claimSet.toString()); // create String to sign with KMS String signingString = encodedHeader + \".\" + encodedClaims; .... } } We now need to use the AWS SDK to create the signing request to pass to KMS to get the signed JWT.\nKey Id is the id of your key from AWS. Signing alg can be selected from a predefined set using software.amazon.awssdk.services.kms.model.SigningAlgorithmSpec;\n.... SignRequest signRequest = SignRequest.builder() .message(SDKBytes.fromByteArray(signingString.getBytes())) .keyId(KEY_ID) .signingAlgorithm(SIGNING_ALG) .build(); SignResponse response = kmsClient.sign(signRequest); String signature = Base64.encode(response.signature().asByteArray()).toString(); return signature; The above call now provides a Base64 encoded version of the signed string that is attached to the request parameters for the invocation of the token endpoint.\nID Token Verification Depending on the supported algorithms for the id token you might find that the ID Token is signed with a different algorithm than the default RS256 that spring supports. In order to override this setting you can again create a custom Bean that sets alternative signatures using the JWSAlgorithmResolver.\n@Bean public JwtDecoderFactory\u003cClientRegistration\u003e idTokenDecoderFactory() { OidcTokenDecoderFactory idTokenDecoderFactory = new OidcTokenDecoderFactory(); idTokenDecoderFactory.setJwsAlgorithmResolver(clientRegistration -\u003e SignatureAlgorithm.RS512); return idTokenDecoderFactory; } ","wordCount":"812","inLanguage":"en","image":"https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2023-12-05T00:00:00Z","dateModified":"2023-12-05T00:00:00Z","author":{"@type":"Person","name":"Greg Simons"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dvla.github.io/posts/2023-12-spring-security-aws-kms/"},"publisher":{"@type":"Organization","name":"DVLA Engineering","logo":{"@type":"ImageObject","url":"https://dvla.github.io/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dvla.github.io/ accesskey=h title="DVLA Engineering (Alt + H)"><img src=https://dvla.github.io/favicon/apple-touch-icon.png alt aria-label=logo height=49>DVLA Engineering</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dvla.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://dvla.github.io/open-source/ title=Open-source><span>Open-source</span></a></li><li><a href=https://github.com/dvla/ title=Github><span>Github</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.civil-service-careers.gov.uk/departments/working-for-the-driver-and-vehicle-licensing-agency/ title=Careers><span>Careers</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dvla.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://dvla.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Spring Security private key jwt with AWS KMS</h1><div class=post-description>How to configure spring security to use private key jwt with AWS KMS</div><div class=post-meta><span title='2023-12-05 00:00:00 +0000 UTC'>December 5, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;812 words&nbsp;·&nbsp;Greg Simons</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#private_key_jwt>private_key_jwt</a></li><li><a href=#oauth2accesstokenresponseclient>OAuth2AccessTokenResponseClient</a></li><li><a href=#creating-a-signed-jwt>Creating a signed JWT</a></li><li><a href=#id-token-verification>ID Token Verification</a></li></ul></nav></div></details></div><div class=post-content><p>As part of our proof of concepts in to the adoption of One Login we setup a Spring Security OAuth 2.0
demo that tested out the <a href=https://docs.sign-in.service.gov.uk/integrate-with-integration-environment/integrate-with-code-flow/#make-a-token-request>integration guide</a>
provided by Government Digital Service (GDS).</p><p>Spring security has long had great OAuth2.0 support from both the server and client elements. Over the last year spring security
added support for the private_key_jwt client authentication method as part of the authorization code grant flow.
<a href=https://github.com/spring-projects/spring-security/pull/9933>Spring Security GitHub ref</a></p><p>The configuration for the key signing requires both the public and private key to be available to the application.
Key Management Service (KMS) by Amazon Web Services (AWS) provides services to centrally manage your keys for encryption
and signing and is an option to allow a more centralised mechanism for key rotation and policy management.</p><p>In order to add this support in to Spring it requires a number of customisations to be made which will be explained in
this post. If your AuthZ server also supports elliptic-curve digital signature algorithms (ECDSA) for the ID token I will
outline the additional Bean configuration required as Spring security defaults to RS256 supported with RSA keys.</p><h2 id=private_key_jwt>private_key_jwt<a hidden class=anchor aria-hidden=true href=#private_key_jwt>#</a></h2><p>The private key jwt client authentication method requires a jwt token to be sent alongside client id, code as a client
assertion to the token endpoint. This jwt will need to be signed and then sent in a client_assertion parameter to the
auth server. A number of algorithms are supported by various auth servers and can be found by visiting the configuration
endpoint of the auth server.</p><p>Full details of the spec can be found here <a href=https://www.rfc-editor.org/rfc/rfc7523.html>rfc 7523</a></p><p>The first configuration change required is to switch out the default access token response client as part of the
HttpSecurity config. This provides the ability to customise the token endpoint request parameters to enrich with the client
assertion signed by kms.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Security</span><span class=w> </span><span class=n>FilterChain</span><span class=w> </span><span class=nf>filterchain</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>http</span><span class=p>.</span><span class=na>oauth2Login</span><span class=p>(</span><span class=n>oauth2Login</span><span class=w> </span><span class=o>-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>oauthLogin</span><span class=p>.</span><span class=na>tokenEndpoint</span><span class=p>(</span><span class=n>tokenEndpoint</span><span class=w> </span><span class=o>-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>tokenEndpoint</span><span class=p>.</span><span class=na>accessTokenResponseClient</span><span class=p>(</span><span class=n>accessTokenResponseClient</span><span class=p>))).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>oauth2Client</span><span class=p>.</span><span class=na>authorizationCodeGrant</span><span class=p>(</span><span class=n>authorizationCodeGrant</span><span class=w> </span><span class=o>-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>authorizationCodeGrant</span><span class=p>.</span><span class=na>accessTokenResponseClient</span><span class=p>(</span><span class=n>accessTokenResponseClient</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>http</span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=oauth2accesstokenresponseclient>OAuth2AccessTokenResponseClient<a hidden class=anchor aria-hidden=true href=#oauth2accesstokenresponseclient>#</a></h2><p>In order to override the request entity handling to add support for the kms signing you need to add a custom request
entity converter to the access token response client that you create.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>OAuth2AccessTokenResponseClient</span><span class=o>&lt;</span><span class=n>OAuthAuthorizationCodeGrantRequest</span><span class=w> </span><span class=nf>accessTokenResponseClient</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>DefaultAuthorizationCodeTokenResponseClient</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultAuthorizationCodeTokenResponseClient</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>client</span><span class=p>.</span><span class=na>setRequestEntityConverter</span><span class=p>(</span><span class=n>converter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>client</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>From this point it is now necessary to create the converter:</p><pre><code>It is important to note whether or not you are creating the beans or are they being managed and created by Spring 
as you could incur a number of errors if the objects are manually instantiated.
</code></pre><p>The converter is the main class that allows the overriding of the request parameters.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CustomKMSJWTClientAuthNConverter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Converter</span><span class=o>&lt;</span><span class=n>OAuth2AuthorizationCodeGrantRequest</span><span class=p>,</span><span class=w> </span><span class=n>RequestEntity</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>OAuth2AuthorizationCodeGrantRequestEntityConverter</span><span class=w> </span><span class=n>defaultConverter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>CustomKMSJWTClientAuthNConverter</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>defaultConverter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OAuth2AuthorizationCodeGrantRequestEntityConverter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>RequestEntity</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>convert</span><span class=p>(</span><span class=n>OAuth2AuthorizationCodeGrantRequest</span><span class=w> </span><span class=n>req</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>signedJWT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createSignedJwt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RequestEntity</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>entity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>defaultConverter</span><span class=p>.</span><span class=na>convert</span><span class=p>(</span><span class=n>req</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MultiValueMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>parameters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MultiValueMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>entity</span><span class=p>.</span><span class=na>getBody</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>parameters</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=s>&#34;client_assertion_type&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;urn:ietf:params:oauth:client-assertion-type:jwt-bearer&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>parameters</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=s>&#34;client_assertion&#34;</span><span class=p>,</span><span class=w> </span><span class=n>signedJWT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestEntity</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>parameters</span><span class=p>,</span><span class=w> </span><span class=n>entity</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>(),</span><span class=w> </span><span class=n>entity</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(),</span><span class=w> </span><span class=n>entity</span><span class=p>.</span><span class=na>getUrl</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=creating-a-signed-jwt>Creating a signed JWT<a hidden class=anchor aria-hidden=true href=#creating-a-signed-jwt>#</a></h2><p>The next step is to create the JWT and use the KMS API to sign the token.</p><p>You will need to setup the AWS SDK and KMS Client. For example, I exported the AWS_SECRET_ACCESS_KEY, AWS_SESSION_TOKEN
and AWS_ACCESS_KEY_ID environment variables and set them on the command line. There are a number of alternatives supported
in spring that can be found here: <a href=https://aws.amazon.com/blogs/opensource/getting-started-with-spring-boot-on-aws-part-1/>AWS SDK on Spring</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>kmsClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KmsClient</span><span class=p>.</span><span class=na>builder</span><span class=p>().</span><span class=na>region</span><span class=p>(</span><span class=n>Region</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=s>&#34;.....&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>credentialsProvider</span><span class=p>(</span><span class=n>DefaultCredentialsProvider</span><span class=p>.</span><span class=na>create</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// tbc values can be configured with your auth server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>createSignedJwt</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>JWTClaimSet</span><span class=p>.</span><span class=na>Builder</span><span class=w> </span><span class=n>claimSetBuilder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JWTClaimSet</span><span class=p>.</span><span class=na>Builder</span><span class=p>().</span><span class=na>audience</span><span class=p>(</span><span class=err>&#39;</span><span class=n>tbc</span><span class=err>&#39;</span><span class=p>).</span><span class=na>issuer</span><span class=p>(</span><span class=err>&#39;</span><span class=n>tbc</span><span class=err>&#39;</span><span class=p>).</span><span class=na>subject</span><span class=p>(</span><span class=err>&#39;</span><span class=n>tbc</span><span class=err>&#39;</span><span class=p>).</span><span class=na>expirationTime</span><span class=p>(</span><span class=n>tbc</span><span class=p>).</span><span class=na>issueTime</span><span class=p>(</span><span class=n>Date</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>Instant</span><span class=p>.</span><span class=na>now</span><span class=p>())).</span><span class=na>jwtId</span><span class=p>(</span><span class=err>&#39;</span><span class=n>tbc</span><span class=err>&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>JWTClaimSet</span><span class=w> </span><span class=n>claimSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>claimSetBuilder</span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sign</span><span class=p>(</span><span class=n>claimSet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>We now have a JWT token ready to sign and verify with KMS.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>sign</span><span class=p>(</span><span class=n>JWTClaimSet</span><span class=w> </span><span class=n>claimSet</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// choose a token alg based on what is supported by your auth Server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>JWSHeader</span><span class=w> </span><span class=n>header</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JWSHeader</span><span class=p>(</span><span class=n>TOKEN_ALG</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Base64URL</span><span class=w> </span><span class=n>encodedHeader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>header</span><span class=p>.</span><span class=na>toBase64URL</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Base64URL</span><span class=w> </span><span class=n>encodedClaims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64URL</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>claimSet</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// create String to sign with KMS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>signingString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>encodedHeader</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>encodedClaims</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>We now need to use the AWS SDK to create the signing request to pass to KMS to get the signed JWT.</p><p>Key Id is the id of your key from AWS.
Signing alg can be selected from a predefined set using
software.amazon.awssdk.services.kms.model.SigningAlgorithmSpec;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>SignRequest</span><span class=w> </span><span class=n>signRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SignRequest</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>.</span><span class=na>message</span><span class=p>(</span><span class=n>SDKBytes</span><span class=p>.</span><span class=na>fromByteArray</span><span class=p>(</span><span class=n>signingString</span><span class=p>.</span><span class=na>getBytes</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>.</span><span class=na>keyId</span><span class=p>(</span><span class=n>KEY_ID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>.</span><span class=na>signingAlgorithm</span><span class=p>(</span><span class=n>SIGNING_ALG</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>SignResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kmsClient</span><span class=p>.</span><span class=na>sign</span><span class=p>(</span><span class=n>signRequest</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>signature</span><span class=p>().</span><span class=na>asByteArray</span><span class=p>()).</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>signature</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>The above call now provides a Base64 encoded version of the signed string that is attached to the request parameters for
the invocation of the token endpoint.</p><h2 id=id-token-verification>ID Token Verification<a hidden class=anchor aria-hidden=true href=#id-token-verification>#</a></h2><p>Depending on the supported algorithms for the id token you might find that the ID Token is signed with a different
algorithm than the default RS256 that spring supports. In order to override this setting you can again create a custom
Bean that sets alternative signatures using the JWSAlgorithmResolver.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>JwtDecoderFactory</span><span class=o>&lt;</span><span class=n>ClientRegistration</span><span class=o>&gt;</span><span class=w> </span><span class=nf>idTokenDecoderFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>OidcTokenDecoderFactory</span><span class=w> </span><span class=n>idTokenDecoderFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OidcTokenDecoderFactory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>idTokenDecoderFactory</span><span class=p>.</span><span class=na>setJwsAlgorithmResolver</span><span class=p>(</span><span class=n>clientRegistration</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>SignatureAlgorithm</span><span class=p>.</span><span class=na>RS512</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>return</span><span class=w> </span><span class=n>idTokenDecoderFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://dvla.github.io/tags/spring/>Spring</a></li><li><a href=https://dvla.github.io/tags/aws/>AWS</a></li></ul><nav class=paginav><a class=prev href=https://dvla.github.io/posts/2023-12-logging-blocks/><span class=title>« Prev</span><br><span>TiL: Save CPU cycles by logging blocks</span>
</a><a class=next href=https://dvla.github.io/posts/2023-11-artefacts-and-atlas/><span class=title>Next »</span><br><span>Artefacts in tests and managing them with Atlas</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://dvla.github.io/>DVLA Engineering</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>