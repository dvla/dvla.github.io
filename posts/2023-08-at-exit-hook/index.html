<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The at_exit function | DVLA Engineering</title>
<meta name=keywords content="Ruby,Kernel,Testing,Today I Learned"><meta name=description content="Using the at_exit function to run functions when a program exits"><meta name=author content="Thomas Feathers"><link rel=canonical href=https://dvla.github.io/posts/2023-08-at-exit-hook/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://dvla.github.io/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dvla.github.io/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dvla.github.io/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://dvla.github.io/favicon/apple-touch-icon.png><link rel=mask-icon href=https://dvla.github.io/favicon/favicon-16x16.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-WH4N9FEEE8"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-WH4N9FEEE8",{anonymize_ip:!1})}</script><meta property="og:title" content="The at_exit function"><meta property="og:description" content="Using the at_exit function to run functions when a program exits"><meta property="og:type" content="article"><meta property="og:url" content="https://dvla.github.io/posts/2023-08-at-exit-hook/"><meta property="og:image" content="https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-23T00:00:00+00:00"><meta property="og:site_name" content="DVLA Engineering"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dvla.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="The at_exit function"><meta name=twitter:description content="Using the at_exit function to run functions when a program exits"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dvla.github.io/posts/"},{"@type":"ListItem","position":2,"name":"The at_exit function","item":"https://dvla.github.io/posts/2023-08-at-exit-hook/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The at_exit function","name":"The at_exit function","description":"Using the at_exit function to run functions when a program exits","keywords":["Ruby","Kernel","Testing","Today I Learned"],"articleBody":"Traditionally, in functional testing, a clean up/tear down script would be run in something called an After hook. These hooks are part of the Cucumber DSL and are designed to execute when a scenario has finished.\nCucumber example:\nAfter do |scenario| if scenario.failed? MultiLogger.clean_logs end end There is a drawback to these hooks where they will fail to run when certain exit codes are returned from the scenario or the program is interrupted. This isn’t great when you need these scripts to execute on every run, regardless of the exit reason.\nThis is where at_exit comes in.\nThe at_exit function The at_exit function is defined in the Kernel module within the Ruby class Object. This makes their methods available in every Ruby Object. This is ideal as we have no complex dependencies to consider when using it.\nat_exit works when a program exits. It guarantees to run at exit regardless of the reason; be it a successful program execution, an uncaught exception or someone manually killing the program (ctrl + c).\nIt works by converting a given block to a Proc and registers it for execution when the program exits.\nExample: Here’s how this function is used in the TYR project to clear our Mailsac account of all temporary inboxes created within the tests.\nat_exit do list_inboxes.map { |i| i['_id'] } .grep(/tyr-e2e-*/) .then { |i| i.each { |inbox| delete_inbox(inbox: inbox) }} end Conclusion For a reliable solution to execute a function/script at program exit in Ruby, the at_exit function is the most reliable to use.\n","wordCount":"255","inLanguage":"en","datePublished":"2023-08-23T00:00:00Z","dateModified":"2023-08-23T00:00:00Z","author":{"@type":"Person","name":"Thomas Feathers"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dvla.github.io/posts/2023-08-at-exit-hook/"},"publisher":{"@type":"Organization","name":"DVLA Engineering","logo":{"@type":"ImageObject","url":"https://dvla.github.io/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dvla.github.io/ accesskey=h title="DVLA Engineering (Alt + H)"><img src=https://dvla.github.io/favicon/apple-touch-icon.png alt aria-label=logo height=49>DVLA Engineering</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dvla.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://dvla.github.io/open-source/ title=Open-source><span>Open-source</span></a></li><li><a href=https://github.com/dvla/ title=Github><span>Github</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.civil-service-careers.gov.uk/departments/working-for-the-driver-and-vehicle-licensing-agency/ title=Careers><span>Careers</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dvla.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://dvla.github.io/posts/>Posts</a></div><h1 class=post-title>The at_exit function</h1><div class=post-description>Using the at_exit function to run functions when a program exits</div><div class=post-meta>&lt;span title='2023-08-23 00:00:00 +0000 UTC'>August 23, 2023&lt;/span>&amp;nbsp;·&amp;nbsp;2 min&amp;nbsp;·&amp;nbsp;255 words&amp;nbsp;·&amp;nbsp;Thomas Feathers</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#the-at_exit-function>The at_exit function</a></li><li><a href=#example>Example:</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details></div><div class=post-content><p>Traditionally, in functional testing, a clean up/tear down script would be run in something called an <code>After</code> hook. These hooks are part of the Cucumber DSL and are designed to execute when a scenario has finished.</p><p>Cucumber example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>After</span> <span class=k>do</span> <span class=o>|</span><span class=n>scenario</span><span class=o>|</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>scenario</span><span class=o>.</span><span class=n>failed?</span>
</span></span><span class=line><span class=cl>    <span class=no>MultiLogger</span><span class=o>.</span><span class=n>clean_logs</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>There is a drawback to these hooks where they will fail to run when certain exit codes are returned from the scenario or the program is interrupted. This isn&rsquo;t great when you need these scripts to execute on every run, regardless of the exit reason.</p><p>This is where <code>at_exit</code> comes in.</p><h2 id=the-at_exit-function>The at_exit function<a hidden class=anchor aria-hidden=true href=#the-at_exit-function>#</a></h2><p>The <code>at_exit</code> function is defined in the <code>Kernel</code> module within the Ruby class Object. This makes their methods available in every Ruby Object. This is ideal as we have no complex dependencies
to consider when using it.</p><p><code>at_exit</code> works when a program exits. It guarantees to run at exit regardless of the reason; be it a successful program execution, an uncaught exception or someone manually killing the program (ctrl + c).</p><p>It works by converting a given block to a <a href=https://ruby-doc.org/core-3.0.0/Proc.html>Proc</a> and registers it for execution when the program exits.</p><h2 id=example>Example:<a hidden class=anchor aria-hidden=true href=#example>#</a></h2><p>Here&rsquo;s how this function is used in the TYR project to clear our Mailsac account of all temporary inboxes created within the tests.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>at_exit</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>list_inboxes</span><span class=o>.</span><span class=n>map</span> <span class=p>{</span> <span class=o>|</span><span class=n>i</span><span class=o>|</span> <span class=n>i</span><span class=o>[</span><span class=s1>&#39;_id&#39;</span><span class=o>]</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=n>grep</span><span class=p>(</span><span class=sr>/tyr-e2e-*/</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=n>then</span> <span class=p>{</span> <span class=o>|</span><span class=n>i</span><span class=o>|</span> <span class=n>i</span><span class=o>.</span><span class=n>each</span> <span class=p>{</span> <span class=o>|</span><span class=n>inbox</span><span class=o>|</span> <span class=n>delete_inbox</span><span class=p>(</span><span class=ss>inbox</span><span class=p>:</span> <span class=n>inbox</span><span class=p>)</span> <span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>For a reliable solution to execute a function/script at program exit in Ruby, the <code>at_exit</code> function is the most reliable to use.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://dvla.github.io/tags/ruby/>Ruby</a></li><li><a href=https://dvla.github.io/tags/kernel/>Kernel</a></li><li><a href=https://dvla.github.io/tags/testing/>Testing</a></li><li><a href=https://dvla.github.io/tags/today-i-learned/>Today I Learned</a></li></ul><nav class=paginav><a class=prev href=https://dvla.github.io/posts/2023-11-artefacts-and-atlas/><span class=title>« Prev</span><br><span>Artefacts in tests and managing them with Atlas</span>
</a><a class=next href=https://dvla.github.io/posts/2023-08-calling-fakermaker-to-generate-numerous-objects/><span class=title>Next »</span><br><span>TiL: Generating numerous FakerMaker objects in one call</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://dvla.github.io/>DVLA Engineering</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>